<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>PyVolvelle Editor</title>

    <script src="vendor/brython.js"></script>
    <script src="vendor/brython_stdlib.js"></script>
    <script src="vendor/codemirror.js"></script>
  </head>

  <body onload="brython(1)" style="overflow: hidden">
    <div class="editor" style="position: absolute; top: 0; left: 0; width: 49%; height: 100%"></div>
    <div class="examples" style="position: absolute; bottom: 0; left: 0; width: 100%"></div>

    <div class="preview" style="position: absolute; top: 0; left: 50%; width: 50%; height: 100%; overflow-y: auto; background-color: slategray"></div>

    <script>
     const examples = {
       names: `
from volvelle import *

class Names(Volvelle):
  def __init__(self):
    self.firstname = OneOf()

  def lastname(self):
    if self.firstname == "Omar":
      return "Rizwan"
    elif self.firstname == "Max":
      return "Krieger"
    elif self.firstname == "Ian":
      return "Clester"
    elif self.firstname == "Andrew":
      return "Blinn"

Names().render()
`,
       doubler: `
from volvelle import *

class Doubler(Volvelle):
  def __init__(self):
    self.x = Slide(1, 10)

  def two_x(self):
    return self.x * 2

Doubler().render()
`
     };

     const {basicSetup} = CM["codemirror"];
     const {EditorView, keymap} = CM["@codemirror/view"];
     const {EditorState} = CM["@codemirror/state"];
     const {python} = CM["@codemirror/lang-python"];

     const liveReload = EditorView.updateListener.of(e => {
       const code = e.state.doc.toString();
       window.code = code;
       try {
         eval(__BRYTHON__.python_to_js(code));
       } catch (e) {
         console.error(e);
       }
     });

     const view = new EditorView({
       doc: examples["names"].trimStart(),
       extensions: [basicSetup, python(), liveReload],
       parent: document.getElementsByClassName("editor")[0]
     });

     window.replaceLine = (from, to, insert) => {
       view.dispatch({
         changes: {from, to, insert}
       });
     };
     
     const examplesEl = document.body.getElementsByClassName("examples")[0];
     for (const [exampleName, exampleCode] of Object.entries(examples)) {
       const btn = document.createElement("button");
       btn.innerText = exampleName;
       examplesEl.appendChild(btn);
       btn.onclick = () => {
         view.dispatch({ changes: {
           from: 0,
           to: view.state.doc.length,
           insert: exampleCode.trimStart()
         } });
       };
     }
    </script>
  </body>
</html>
